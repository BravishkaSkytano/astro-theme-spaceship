---
import { getCollection } from "astro:content";

import {
  DOCUMENTS_COLLECTION_NAME,
} from "../constants";
import type {
  DocumentContext,
  NavigationContext,
  PageContext,
} from "../types";

import website from "../../website.config.mjs";
import { buildPage } from "../helpers/buildPage";

import type { GetStaticPaths } from "astro";
import Article from "../components/Article.astro";
import Layout from "../components/Layout.astro";
import LeftSidebar from "../components/LeftSidebar.astro";
import RightSidebar from "../components/RightSidebar.astro";
import { buildTree } from "../helpers/buildTree";

export type Props = {
  document: DocumentContext;
  navigation: NavigationContext;
  page: PageContext;
};

export const getStaticPaths = (async () => {
  const documents = await getCollection(DOCUMENTS_COLLECTION_NAME);

  const tree = buildTree(documents);

  return documents.map((document) => ({
    params: { slug: document.id },
    props: {
      document,
      navigation: {
        tree,
        backlinks: documents.filter(
          d => d.data.links?.some(l => l.href === document.data.permalink)
        )
      },
      page: buildPage(document),
    } satisfies Props,
  }));
}) satisfies GetStaticPaths;

const { document, navigation, page } = Astro.props;
---
<Layout page={page} document={document}>
  <LeftSidebar website={website} navigation={navigation} />
  <Article document={document} />
  <RightSidebar document={document} navigation={navigation} />
</Layout>